var AI_CHAT_FONT_SIZE="aiChatFontSize";const AI_TIMEOUT=1e5;function sendOpenAIStreamCallAjax(){""!=$("#aipromptform-prompt").val()?($("#sendButton").prop("disabled",!0),ajaxCall({prompt:$("#aipromptform-prompt").val()},"/ai/send-stream-ajax",function(o){$("#aipromptform-output").val("");var a=new EventSource("/ai/event-stream");loading(),a.onmessage=function(e){if("[DONE]"==e.data){$("#sendButton").prop("disabled",!1),a.close();var t=$("#aipromptform-output").val().replace(/(?:\r\n|\r|\n)/g,"<br/>");$("#aiHistoryList").prepend("<div>"+o.date+'<br/><i class="fa fa-arrow-right"></i> '+$("#aipromptform-prompt").val()+'<br/><br/><i class="fa fa-arrow-left"></i> '+t+"<br/><hr/></div>"),$("#aipromptform-prompt").focus(),updateTokens()}else{e=JSON.parse(e.data).choices[0].delta.content;if(void 0!==e){let t=$("#aipromptform-output").val();0==t.trim().length&&"\n\n"==e||$("#aipromptform-output").val($("#aipromptform-output").val()+e)}}},a.onerror=function(t){console.log(t),loaded(),$("#sendButton").prop("disabled",!1),a.close()},trackEvent("AI Writer Send","click")})):(showNotificationWarning(lajax.t("Please enter your prompt...")),$("#aipromptform-prompt").focus())}$("document").ready(function(){null!==getOption(AI_CHAT_FONT_SIZE)&&setChatFontSize(chatFontSize=getOption(AI_CHAT_FONT_SIZE))});const SEL_TXT_TOO_LONG=lajax.t("Selected input text is too long, please select less text...");function aiSend(t){t.trim().length/4<2e3?aiCommand(t,"","Send",.7):showNotificationWarning(SEL_TXT_TOO_LONG)}function aiRewrite(t){t.trim().length/4<2e3?aiCommand(t,lajax.t("Rewrite this text:"),"Rewrite",.7):showNotificationWarning(SEL_TXT_TOO_LONG)}function aiSummarize(t){t.trim().length/4<3e3?aiCommand(t,lajax.t("Summarize this for a second-grade student:"),"Summarize",.7):showNotificationWarning(SEL_TXT_TOO_LONG)}function aiKeywords(t){t.trim().length/4<3e3?aiCommand(t,lajax.t("Extract keywords:"),"Keywords",0):showNotificationWarning(SEL_TXT_TOO_LONG)}function aiTranslate(t,e="en"){var o;t.trim().length/4<2e3?(o=lajax.t("Translate this into English:"),"pl"==e?o=lajax.t("Translate this into Polish:"):"de"==e?o=lajax.t("Translate this into German:"):"fr"==e?o=lajax.t("Translate this into French:"):"es"==e&&(o=lajax.t("Translate this into Spanish:")),aiCommand(t,o,"Translate "+e,.3)):showNotificationWarning(SEL_TXT_TOO_LONG)}function aiCommand(t,e,o,a=.7){var n;1<t.trim().length?($("#sendButton").prop("disabled",!0),n=t,0<e.length&&(n=e+"\r\n"+t),ajaxCall({prompt:n,temperature:a},"/ai/send-ajax",function(t){$("#tokensInfo").html(t.tokensUsed+" / "+t.maxTokens);t=t.ret.trim().replace(/([^\n\r]*)[\n]+/g,"<p>$1</p>\r\n");useTiny?($("#aiReplaceSelection").prop("checked")||tinymce.activeEditor.selection.collapse(),tinymce.activeEditor.insertContent(t)):(froalaEditor.undo.saveStep(),$("#aiReplaceSelection").prop("checked")||froalaEditor.selection.clear(),froalaEditor.html.insert(t),froalaEditor.size.syncIframe(),froalaEditor.undo.saveStep()),setTimeout(function(){contentChange()},50)},void 0,function(){$("#sendAIModalButton").prop("disabled",!1)},AI_TIMEOUT),trackEvent("AI Command",o)):showNotificationWarning(lajax.t("Please enter some text in the Visual Editor (optionally select a part of text to process)."))}function updateTokens(){ajaxCall({},"/ai/update-tokens-ajax",function(t){$("#tokensInfo").html(t.tokensUsed+" / "+t.maxTokens)})}function sendOpenAICallModalAjax(){1<$("#aipromptform-prompt").val().trim().length?($("#sendAIModalButton").prop("disabled",!0),ajaxCall({prompt:$("#aipromptform-prompt").val()},"/ai/send-stream-ajax",function(t){console.log(t),$("#aipromptform-output").val("");var o=new EventSource("/ai/event-stream");loading(),o.onmessage=function(e){if("[DONE]"==e.data)$("#sendAIModalButton").prop("disabled",!1),o.close(),$("#aipromptform-output").focus(),$("#aipromptform-output").val().includes("```")?$("#extractHTMLIntoVisualEditor").fadeIn():$("#extractHTMLIntoVisualEditor").fadeOut(),updateTokens();else{e=JSON.parse(e.data).choices[0].delta.content;if(void 0!==e){let t=$("#aipromptform-output").val();0==t.trim().length&&"\n\n"==e||$("#aipromptform-output").val($("#aipromptform-output").val()+e),$("#aipromptform-output").scrollTop($("#aipromptform-output")[0].scrollHeight)}}},o.onerror=function(t){console.log(t),loaded(),$("#sendAIModalButton").prop("disabled",!1),o.close()}},void 0,function(){$("#sendAIModalButton").prop("disabled",!1)},AI_TIMEOUT),trackEvent("AI Modal Send","click")):(showNotificationWarning(lajax.t("Please enter your prompt...")),$("#aipromptform-prompt").focus())}function alertAboutMissingOutput(){alert(lajax.t("There is nothing to insert, please Send something to AI first...")),$("#aipromptform-prompt").focus()}function insertReplyIntoVisualEditor(){var t,e=getOutputSelection();0!=e.trim().length?(t=!1,e.startsWith("<html")||e.startsWith("<!DOCTYPE")?($("#fullPageMode").prop("checked",!0).change(),t=!0):e=(e=(e=e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")).replaceAll("\r\n","<br/>").replaceAll("\n","<br/>").replaceAll("\r","<br/>")).replaceAll("  ","&nbsp;&nbsp;"),useTiny?t?tinymce.activeEditor.setContent(e):tinymce.activeEditor.insertContent(e):(t?froalaEditor.html.set(e):froalaEditor.html.insert(e),froalaEditor.size.syncIframe()),$("#aiModal").modal("hide"),setTimeout(function(){contentChange()},50)):alertAboutMissingOutput()}function extractHTMLCodeAndInsertIntoVisualEditor(){var t,e,o=document.getElementById("aipromptform-output").value;0!=o.trim().length?(e=t=!1,(t=o.includes("```")&&o.includes("html")?!0:t)?((o.startsWith("<html")||o.startsWith("<!DOCTYPE")||o.includes("``")&&((o=o.includes("```html")?o.substring(o.indexOf("```html")+7,o.lastIndexOf("```")):o.substring(o.indexOf("```")+3,o.lastIndexOf("```"))).includes("<html")||o.includes("<!DOCTYPE")))&&($("#fullPageMode").prop("checked",!0).change(),e=!0),useTiny?e?tinymce.activeEditor.setContent(o):tinymce.activeEditor.insertContent(o):(e?froalaEditor.html.set(o):froalaEditor.html.insert(o),froalaEditor.size.syncIframe()),$("#aiModal").modal("hide"),setTimeout(function(){contentChange()},50)):alert(lajax.t("There is no HTML code in the reply..."))):alertAboutMissingOutput()}function insertExamplePromptIntoPromptTextarea(t){$("#aipromptform-prompt").val(t);var e=t.indexOf("["),t=t.indexOf("]");-1<e&&-1<t&&e<t&&createSelection(document.getElementById("aipromptform-prompt"),e,t+1),calculatePromptTokens(),$("#aipromptform-prompt").focus(),trackEvent("AI Modal Prompt","select")}function createSelection(t,e,o){var a;t.createTextRange?((a=t.createTextRange()).collapse(!0),a.moveStart("character",e),a.moveEnd("character",o),a.select(),t.focus()):t.setSelectionRange?(t.focus(),t.setSelectionRange(e,o)):void 0!==t.selectionStart&&(t.selectionStart=e,t.selectionEnd=o,t.focus())}function clearPrompt(){$("#aipromptform-prompt").val("")}function openInVisualEditor(){var t;""!=$("#aipromptform-output").val()?(t=convertTextToHTML(getOutputSelection()),setOption(HTML_CONTENT,t),setOption(SELECTED_DOC_ID,null),window.open("/html-editor-online","_blank").focus()):(showNotificationWarning(lajax.t("There is nothing to edit, please send something to AI first...")),$("#aipromptform-prompt").focus())}function convertTextToHTML(t){return 4<t.length&&"\r\n\r\n"!=t.substring(t.length-4)&&(t+="\r\n\r\n"),t=(t=(t=t.replace(/([\s\S]*?)[\r\n]{2,}/g,"<p>$1</p>")).replace(/\n/g,"<br/>")).replaceAll("</p>","</p>\r\n")}function calculatePromptTokens(){var t=Math.ceil($("#aipromptform-prompt").val().length/4);$("#promptTokensCount").html(lajax.t("Tokens:")+" "+t),3e3<t?($("#tokensError").fadeIn(),$("#sendButton").prop("disabled",!0)):($("#tokensError").fadeOut(),$("#sendButton").prop("disabled",!1))}function deleteHistoryItem(t){confirmModal(lajax.t("Are you sure to delete?"),function(){ajaxCall({id:t},"/ai/delete-writer-item-ajax",function(t){$.pjax.reload({container:"#aiHistoryPjax",async:!1})})})}function deleteAllHistory(){confirmModal(lajax.t("Are you sure to delete your all AI history?"),function(){ajaxCall({},"/ai/delete-writer-history-ajax",function(t){$.pjax.reload({container:"#aiHistoryPjax",async:!1})})})}var chatFontSize=14;function increaseChatFontSize(){chatFontSize<32&&chatFontSize++,setChatFontSize(chatFontSize),setOption(AI_CHAT_FONT_SIZE,chatFontSize)}function setChatFontSize(t){$("#aipromptform-output").css("font-size",t+"px"),$("#aipromptform-prompt").css("font-size",t+"px")}function decreaseChatFontSize(){10<chatFontSize&&chatFontSize--,setChatFontSize(chatFontSize),setOption(AI_CHAT_FONT_SIZE,chatFontSize)}function getOutputSelection(){var t=document.getElementById("aipromptform-output"),e=t.selectionStart,o=t.selectionEnd;return e<o?t.value.substring(e,o):t.value}function copyHistoryPromptToClipboard(t){copyAIContentToClipboard(document.getElementById("aiHistoryPrompt"+t).innerText)}function copyHistoryOutputToClipboard(t){copyAIContentToClipboard(document.getElementById("aiHistoryOutput"+t).innerText)}function copyToClipboard(){var t=getOutputSelection();0<t.trim().length?copyAIContentToClipboard(t):showNotificationWarning(lajax.t("There is nothing to copy, please send something to AI first..."))}function copyAIContentToClipboard(t){var e,o;void 0!==navigator.clipboard?"function"==typeof ClipboardItem?(e=new Blob([t],{type:"text/plain"}),o=new Blob([convertTextToHTML(t)],{type:"text/html"}),navigator.clipboard.write([new ClipboardItem({"text/plain":e,"text/html":o})]).then(function(){},function(){alert(lajax.t("Copy data blob to clipboard failed"))})):navigator.clipboard.writeText(convertTextToHTML(t)).then(function(){},function(){alert(lajax.t("Copy to clipboard failed"))}):(o=$("<textarea>"),$("body").append(o),o.val(t).select(),document.execCommand("copy"),o.remove(),$("#aipromptform-prompt").focus())}